blueprint:
  name: ÐŸÑ€Ð¾Ð±ÑƒÐ¶Ð´Ð°ÑŽÑ‰Ð¸Ð¹ ÑÐ²ÐµÑ‚
  description: ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð»Ð°Ð²Ð½Ð¾Ð³Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ†Ð²ÐµÑ‚Ð° Ð¸ ÑÑ€ÐºÐ¾ÑÑ‚Ð¸ Ð»Ð°Ð¼Ð¿Ð¾Ñ‡ÐºÐ¸ ÑƒÑ‚Ñ€Ð¾Ð¼.
  domain: automation
  input:
    conditions:
      name: Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ
      description: Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      default: []
      selector:
        condition:

    alarm_start_time:
      name: ðŸ•’ Ð’Ñ€ÐµÐ¼Ñ Ð½Ð°Ñ‡Ð°Ð»Ð°
      description: Ð”Ð°Ñ‚Ð° Ð¸ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      selector:
        entity:
          filter:
            - domain:
                - input_datetime
            - domain: sensor
              device_class: timestamp
          multiple: false

    offset_from_start_time:
      name: ðŸ Ð¡Ð´Ð²Ð¸Ð³ Ð¾Ñ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð½Ð°Ñ‡Ð°Ð»Ð°
      description: Ð’Ñ€ÐµÐ¼Ñ Ð´Ð¾ Ð¸Ð»Ð¸ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð´Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°. Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐµÐºÑƒÐ½Ð´Ñ‹ Ð¸Ð»Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ HH:MM:SS (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, "-00:05:00" Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ‡ÐµÑ€ÐµÐ· 5 Ð¼Ð¸Ð½ÑƒÑ‚ Ð´Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð½Ð°Ñ‡Ð°Ð»Ð°. Ð£Ð´Ð¾Ð±Ð½Ð¾, ÐµÑÐ»Ð¸ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ÑÑ Ð¸Ð· ÑÑƒÑ‰Ð½Ð¾ÑÑ‚Ð¸ Ñ‚Ñ€ÐµÐ²Ð¾Ð³Ð¸ Ð¸ Ð²Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¾Ñ‚Ñ€ÐµÐ³ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ, Ð³Ð´Ðµ Ð² Ñ†Ð¸ÐºÐ»Ðµ ÑÑ€ÐºÐ¾ÑÑ‚Ð¸ Ð²Ñ‹ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÐµÑÑŒ, ÐºÐ¾Ð³Ð´Ð° ÑÑ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ñ‚Ñ€ÐµÐ²Ð¾Ð³Ð°. Ð¡Ð¼. https://www.home-assistant.io/docs/automation/trigger/#sensors-of-datetime-device-class-with-offsets Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚ÐµÑ€ÐµÐ¶ÐµÐ½Ð¸Ð¹ Ð¿Ñ€Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ð¸ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÑÐ¼ÐµÑ‰ÐµÐ½Ð¸Ð¹.
      default: "-00:00:00"
      selector:
        text:

    min_brightness_pct:
      description: ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ€ÐºÐ¾ÑÑ‚ÑŒ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð°Ñ… Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      selector:
        number:
          min: 1
          max: 30
          unit_of_measurement: "%"
      default: 1
      name: ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ€ÐºÐ¾ÑÑ‚ÑŒ

    max_brightness_pct:
      description: ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ€ÐºÐ¾ÑÑ‚ÑŒ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð°Ñ… Ð² ÐºÐ¾Ð½Ñ†Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      selector:
        number:
          min: 31
          max: 100
          unit_of_measurement: "%"
      default: 80
      name: ÐšÐ¾Ð½ÐµÑ‡Ð½Ð°Ñ ÑÑ€ÐºÐ¾ÑÑ‚ÑŒ

    duration:
      description: Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ð°Ñ…
      selector:
        number:
          min: 1
          max: 60
      default: 10
      name: Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹

    steps_per_minute:
      description: ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑˆÐ°Ð³Ð¾Ð² Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑÐ²ÐµÑ‚Ð° Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
      selector:
        number:
          min: 1
          max: 12
      default: 12
      name: Ð¨Ð°Ð³Ð¾Ð² Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ

    target_light:
      description: ÐžÐ´Ð¸Ð½ ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒÐ½Ð¸Ðº Ð¸Ð»Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð° ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒÐ½Ð¸ÐºÐ¾Ð²
      selector:
        entity:
          filter:
            domain: light
      name: Ð¦ÐµÐ»ÐµÐ²Ð¾Ð¹ ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒÐ½Ð¸Ðº

    light_timeout:
      description: ÐœÐ¸Ð½ÑƒÑ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ ÑÐ²ÐµÑ‚ Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸. Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ 0 Ð¾Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ ÑÐ²ÐµÑ‚ Ð½Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½
      selector:
        number:
          min: 0
          max: 60
      default: 5
      name: Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÑÐ²ÐµÑ‚Ð°

    start_g_color:
      description: ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð·ÐµÐ»ÐµÐ½Ð¾Ð³Ð¾ Ñ†Ð²ÐµÑ‚Ð° (0-255)
      selector:
        number:
          min: 0
          max: 255
      default: 0
      name: ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð·ÐµÐ»ÐµÐ½Ð¾Ð³Ð¾ Ñ†Ð²ÐµÑ‚Ð°

    end_g_color:
      description: ÐšÐ¾Ð½ÐµÑ‡Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð·ÐµÐ»ÐµÐ½Ð¾Ð³Ð¾ Ñ†Ð²ÐµÑ‚Ð° (0-255)
      selector:
        number:
          min: 0
          max: 255
      default: 190
      name: ÐšÐ¾Ð½ÐµÑ‡Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð·ÐµÐ»ÐµÐ½Ð¾Ð³Ð¾ Ñ†Ð²ÐµÑ‚Ð°

    start_b_color:
      description: ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÑÐ¸Ð½ÐµÐ³Ð¾ Ñ†Ð²ÐµÑ‚Ð° (0-255)
      selector:
        number:
          min: 0
          max: 255
      default: 0
      name: ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÑÐ¸Ð½ÐµÐ³Ð¾ Ñ†Ð²ÐµÑ‚Ð°

    end_b_color:
      description: ÐšÐ¾Ð½ÐµÑ‡Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÑÐ¸Ð½ÐµÐ³Ð¾ Ñ†Ð²ÐµÑ‚Ð° (0-255)
      selector:
        number:
          min: 0
          max: 255
      default: 100
      name: ÐšÐ¾Ð½ÐµÑ‡Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÑÐ¸Ð½ÐµÐ³Ð¾ Ñ†Ð²ÐµÑ‚Ð°


triggers:
  - trigger: time
    at:
      entity_id: !input alarm_start_time
      offset: !input offset_from_start_time

condition:
  condition: and
  conditions: !input conditions

variables:
  min_brightness_pct: !input min_brightness_pct
  max_brightness_pct: !input max_brightness_pct
  duration: !input duration
  steps_per_minute: !input steps_per_minute
  target_light: !input target_light
  light_timeout: !input light_timeout

  steps: "{{ duration * steps_per_minute }}"
  min_brightness: "{{ min_brightness_pct * 2.55 }}"
  max_brightness: "{{ max_brightness_pct * 2.55 }}"
  bright_step: "{{ (max_brightness - min_brightness) / steps }}"

  start_g_color: !input start_g_color
  end_g_color: !input end_g_color
  g_color_step: "{{ (end_g_color - start_g_color) / steps }}"

  start_b_color: !input start_b_color
  end_b_color: !input end_b_color
  b_color_step: "{{ (end_b_color - start_b_color) / steps }}"

  start_time: "{{ as_timestamp(now()) }}"
  individual_step: "{{ 60 / steps_per_minute }}"

actions:
  - data:
      brightness: "{{ min_brightness }}"
      rgb_color: "{{ [255, start_g_color, start_b_color] }}"
    target:
      entity_id: "{{ target_light }}"
    action: light.turn_on
  - repeat:
      until:
        - condition: or
          conditions:
            - condition: template
              value_template: "{{ is_state(target_light, 'off') }}"
            - condition: template
              value_template: "{{ state_attr(target_light, 'brightness') >= max_brightness }}"
            - condition: template
              value_template: >-
                {{ (((as_timestamp(now()) - start_time) / individual_step) |
                round(0, "ceil")) > steps }}
      sequence:
        - variables:
            steps_to_now: |-
              {{ ((as_timestamp(now()) - start_time) / individual_step) |
                round(0, "ceil") }}
            brightness: >-
              {{ min_brightness + (bright_step * steps_to_now) | round(0,
              'ceil') }}
            g_color: >-
              {{ start_g_color + (g_color_step * steps_to_now) | round(0,
              'ceil') }}
            b_color: >-
              {{ start_b_color + (b_color_step * steps_to_now) | round(0,
              'ceil') }}
        - delay:
            seconds: "{{ individual_step }}"
        - if:
            - condition: template
              value_template: "{{ not is_state(target_light, 'off') }}"
          then:
            - data:
                brightness: "{{ brightness }}"
                rgb_color: "{{ [255, g_color, b_color] }}"
                transition: "{{ individual_step / 2 }}"
              target:
                entity_id: "{{ target_light }}"
              action: light.turn_on
  - if:
      - condition: and
        conditions:
          - condition: template
            value_template: "{{ light_timeout != 0 }}"
          - condition: template
            value_template: "{{ not is_state(target_light, 'off') }}"
    then:
      - delay:
          minutes: "{{ light_timeout }}"
      - data: {}
        target:
          entity_id: "{{ target_light }}"
        action: light.turn_off

mode: single
